<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><script>var yiliaConfig={fancybox:!0,animate:!1,isHome:!1,isPost:!1,isArchive:!0,isTag:!1,isCategory:!1,open_in_new:!0,rootUrl:"/"}</script><title>ADB-PG</title><link rel=icon href=/favicon.png><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/font-awesome/css/font-awesome.min.css><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=stylesheet href=/fancybox/jquery.fancybox.css><link rel=stylesheet href=/highlight/styles/intellij-light.min.css><script src=/highlight/highlight.pack.js></script>
<script>hljs.initHighlightingOnLoad()</script></head><body><body><div id=container><div class=left-col><div class=overlay></div><div class=intrude-less><header id=header class=inner><a href=/ class=profilepic><img src=/img/head-portrait.jpg class="animated zoomIn js-avatar"></a><hgroup><h1 class=header-author><a href=/>aliveyang</a></h1></hgroup><p class=header-subtitle>无处觅菰蒲</p><div id=switch-btn class=switch-btn><div class=icon><div class=icon-ctn><div class="icon-wrap icon-house" data-idx=0><div class=birdhouse></div><div class=birdhouse_holes></div></div><div class="icon-wrap icon-ribbon hide" data-idx=1><div class=ribbon></div></div><div class="icon-wrap icon-link hide" data-idx=2><div class=loopback_l></div><div class=loopback_r></div></div><div class="icon-wrap icon-me hide" data-idx=3><div class=user></div><div class=shoulder></div></div></div></div><div class="tips-box hide"><div class=tips-arrow></div><ul class=tips-inner><li>菜单</li><li>标签</li><li>友情链接</li><li>关于我</li></ul></div></div><div id=switch-area class=switch-area><div class=switch-wrap><section class="switch-part switch-part1"><nav class=header-menu><ul><li><a href=/./>主页</a></li><li><a href=/./post/>所有文章</a></li><li><a href=/./tags/>标签云</a></li></ul></nav><nav class=header-nav><ul class=social></ul></nav></section><section class="switch-part switch-part2"><div class="widget tagcloud" id=js-tagcloud><a href=/tags/db style=font-size:12px class=color4>Db</a>
<a href=/tags/hugo style=font-size:12px class=color4>Hugo</a>
<a href=/tags/java style=font-size:12px class=color2>Java</a>
<a href=/tags/temp style=font-size:12px class=color2>Temp</a>
<a href=/tags/win style=font-size:12px class=color1>Win</a></div></section><section class="switch-part switch-part3"><div id=js-friends><a target=_self class="main-nav-link switch-friends-link" href=https://v2ex.com>v2ex</a>
<a target=_self class="main-nav-link switch-friends-link" href=https://coolshell.cn/>酷壳</a></div></section><section class="switch-part switch-part4"><div id=js-aboutme>无处觅菰蒲</div></section></div></div></header></div></div><div class=mid-col><nav id=mobile-nav><div class=overlay><h1 class="header-author js-mobile-header hide"><a href=/ title=回到主页>aliveyang</a></h1></div><div class=intrude-less><header id=header class=inner><a href=/ class=profilepic><img src=/img/head-portrait.jpg class="animated zoomIn"></a><hgroup><h1 class=header-author><a href=/ title=回到主页>aliveyang</a></h1></hgroup><p class=header-subtitle>无处觅菰蒲</p><nav class=header-menu><ul><li><a href=/./>主页</a></li><li><a href=/./post/>所有文章</a></li><li><a href=/./tags/>标签云</a></li><div class=clearfix></div></ul></nav><nav class=header-nav><ul class=social></ul></nav></header></div></nav><div class=body-wrap><article id=post-js-android class="article article-type-post" itemscope itemprop=blogPost><div class=article-meta><a href=https://aliveyang.top/post/aliadbpg/ class=article-date><time datetime="2021-01-02 00:00:00 +0000 UTC" itemprop=datePublished>2021-01-02</time></a></div><div class=article-inner><input type=hidden class=isFancy><header class=article-header><h1 class=article-title itemprop=name><a class=article-title href=https://aliveyang.top/post/aliadbpg/>ADB-PG</a></h1></header><div class="article-info article-info-post"><div class="article-tag tagcloud"><ul class=article-tag-list><li class=article-tag-list-item><a class="article-tag-list-link color1" href=/tags/db/ style=font-size:12px>db</a></li></ul></div><div class=clearfix></div></div><div class=article-entry itemprop=articleBody><p><strong>阿里 AnalyticDB PostgreSQL版</strong></p><h2 id=实例选型>实例选型</h2><p>以存储预留模式的节点4core SSD存储为例，单节点存储320GB，假设用户数据为4TB，且一般预留30%水位 ，需要规划4TB / (1 - 30%) / 320 GB</p><h2 id=逻辑架构>逻辑架构</h2><ul><li>ADB-PG<ul><li>Database<ul><li>Schema<ul><li>Table</li></ul></li></ul></li></ul></li></ul><h2 id=表定义>表定义</h2><ul><li>hash值分布 <code>DISTRIBUTED BY (p_id)</code>
<code>按照业务使用频率选择分布键</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>create</span> <span style=color:#66d9ef>table</span> demo (
</span></span><span style=display:flex><span>	name varchar(<span style=color:#ae81ff>40</span>),
</span></span><span style=display:flex><span>	age integer,
</span></span><span style=display:flex><span>	p_id integer)
</span></span><span style=display:flex><span>DISTRIBUTED <span style=color:#66d9ef>BY</span> (p_id);
</span></span></code></pre></div><ul><li>随机均分布 <code>DISTRIBUTED RANDOMLY</code>
<code>尽量不使用</code></li><li>全量复制 <code>DISTRIBUTED REPLICATED</code>
<code>数据量小的基表</code></li></ul><h2 id=分布式join>分布式JOIN</h2><ul><li>Collocated Join: join本地完成</li><li>Redistribution Join: 节点一对多，重分布</li><li>Broadcast Join: 节点多对多，广播</li></ul><h2 id=分布键>分布键</h2><p>表分布键选择原则：</p><ol><li>选择数据分布均匀的列</li><li>选择经常需要JOIN的列</li><li>尽量选择高频出现查询条件的列</li><li>若未指定分布键，默认表的主键</li><li>分布键可以定义一个或多个列</li><li>避免选择随机分布，将使本地关联、节点裁剪不可能实现</li></ol><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- 数据倾斜检查
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>select</span> gp_segment_id, <span style=color:#66d9ef>count</span>(<span style=color:#ae81ff>1</span>) <span style=color:#66d9ef>from</span> t1 <span style=color:#66d9ef>group</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>1</span> <span style=color:#66d9ef>order</span> <span style=color:#66d9ef>by</span> <span style=color:#ae81ff>2</span> <span style=color:#66d9ef>desc</span>
</span></span></code></pre></div><h2 id=表分区>表分区</h2><ul><li>范围（RANGE）分区：基于一个数值型范围划分数据</li><li>值（LIST）分区：基于一个值列表划分数据</li><li>多级分区表：上述组合，最多支持三级分区</li></ul><h2 id=数据存储>数据存储</h2><ul><li>行存表 <code>create table foo (a int, b text) distributed by (a);</code></li><li>列存表 <code>create table foo (a int, b text) with (appendonly = true, orientation = column) distributed by (a);</code></li><li>行列混合</li></ul><h2 id=执行计划>执行计划</h2><ul><li>explain: 基于统计信息，不真正执行语句</li><li>explain analyze：真正执行语句，显示真实信息</li></ul><h2 id=统计信息>统计信息</h2><table><thead><tr><th>收集范围</th><th>语句示例</th></tr></thead><tbody><tr><td>全库</td><td>analyze;</td></tr><tr><td>表</td><td>analyze t1;</td></tr><tr><td>列</td><td>analyze t1(c1);</td></tr><tr><td>收集建议：</td><td></td></tr></tbody></table><ol><li>根据实际情况确认收集范围</li><li>超过20%数据更新，需要进行统计信息收集</li><li>用户ETL任务过程中，会涉及多次IUD，可根据情况添加</li><li>调优过程中，估算值与实际值相差过大（计划中出现较多的Broadcast、Sort+GroupByAgg、NestLoop等算子）</li></ol></div></div><nav id=article-nav><div id=article-nav-older class=article-nav-title><a href=/post/softwarebak/>Win备忘</a></div></nav></article><div id=toc class=toc-article><strong class=toc-title>文章目录</strong><ol class=toc><nav id=TableOfContents><ul><li><a href=#实例选型>实例选型</a></li><li><a href=#逻辑架构>逻辑架构</a></li><li><a href=#表定义>表定义</a></li><li><a href=#分布式join>分布式JOIN</a></li><li><a href=#分布键>分布键</a></li><li><a href=#表分区>表分区</a></li><li><a href=#数据存储>数据存储</a></li><li><a href=#执行计划>执行计划</a></li><li><a href=#统计信息>统计信息</a></li></ul></nav></ol></div><style>.left-col .switch-btn{display:none}.left-col .switch-area{display:none}@media only screen and (min-device-width:320px) and (max-device-width:480px){#mobileAd{width:100%;height:250px}}@media only screen and (min-device-width:320px) and (max-device-width:480px){#musicAd{width:100%}}</style><script>var valueHide="隐藏目录",valueShow="显示目录";$(".left-col").is(":hidden")&&$("#tocButton").attr("value",valueShow),$("#tocButton").click(function(){$("#toc").is(":hidden")?($("#tocButton").attr("value",valueHide),$("#toc").slideDown(320),$(".switch-btn, .switch-area").fadeOut(300)):($("#tocButton").attr("value",valueShow),$("#toc").slideUp(350),$(".switch-btn, .switch-area").fadeIn(500))})</script><div class=share style=display:none></div><div class=scroll id=post-nav-button><a href=/ title=回到主页><i class="fa fa-home"></i></a>
<a title=文章列表><i class="fa fa-bars"></i><i class="fa fa-times"></i></a>
<a href=/post/softwarebak/ title="下一篇: Win备忘"><i class="fa fa-angle-right"></i></a></div><ul class="post-list toc-article"><li class=post-list-item><a class=post-list-link href=/post/aliadbpg/ target=_self>ADB-PG</a></li><li class=post-list-item><a class=post-list-link href=/post/softwarebak/ target=_self>Win备忘</a></li><li class=post-list-item><a class=post-list-link href=/post/maven/ target=_self>Maven</a></li><li class=post-list-item><a class=post-list-link href=/post/jdk8stream/ target=_self>JDK8 Stream</a></li><li class=post-list-item><a class=post-list-link href=/post/github/ target=_self>GitHub使用</a></li><li class=post-list-item><a class=post-list-link href=/post/welcome/ target=_self>Welcome</a></li></ul><script>$(".post-list").addClass("toc-article"),$(".post-list-item a").attr("target","_Self"),$("#post-nav-button > a:nth-child(2)").click(function(){$(".fa-bars, .fa-times").toggle(),$(".post-list").toggle(300),$(".toc").length>0?$("#toc, #tocButton").toggle(200,function(){$(".switch-area").is(":visible")&&($("#toc, .switch-btn, .switch-area").toggle(),$("#tocButton").attr("value",valueHide))}):$(".switch-btn, .switch-area").fadeToggle(300)})</script><script>(function(e){setInterval(()=>{e.each(e("iframe"),(t,n)=>{let s=e(n).attr("src");s==null&&e(n).remove()})},300)})(jQuery)</script><script></script></div><footer id=footer><div class=outer><div id=footer-info><div class=footer-left>&copy; 2023 aliveyang</div><div class=footer-right><a href=http://gohugo.io/ target=_self>Hugo</a> Theme <a href=https://github.com/NightFarmer/hugo-theme-yelee target=_blank>Yelee</a> by NightFarmer</div></div><div class=visit><span id=busuanzi_container_site_pv style=display:none><span id=site-visit>本站到访数:
<span id=busuanzi_value_site_uv></span></span></span>
<span>,</span>
<span id=busuanzi_container_page_pv style=display:none><span id=page-visit>本页阅读量:
<span id=busuanzi_value_page_pv></span></span></span></div></div></footer></div><script src=/js/main.js></script>
<script>$(document).ready(function(){var e=["#9db3f4","#414141","#e5a859","#f5dfc6","#c084a0","#847e72","#cd8390","#996731"],t=Math.ceil(Math.random()*(e.length-1));$("body").css({"background-color":e[t],"background-size":"cover"})})</script><div class=scroll id=scroll><a href=# title=返回顶部><i class="fa fa-arrow-up"></i></a>
<a href=#footer title=转到底部><i class="fa fa-arrow-down"></i></a></div><script>$(document).ready(function(){$("#comments").length<1&&$("#scroll > a:nth-child(2)").hide()})</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><script>(function(){var t,e=document.createElement("script"),n=window.location.protocol.split(":")[0];n==="https"?e.src="https://zz.bdstatic.com/linksubmit/push.js":e.src="http://push.zhanzhang.baidu.com/push.js",t=document.getElementsByTagName("script")[0],t.parentNode.insertBefore(e,t)})()</script></div></body></html>